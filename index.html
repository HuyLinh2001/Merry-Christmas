<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Merry Christmas 2025</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; }
        #canvas-container { width: 100vw; height: 100vh; position: fixed; top: 0; left: 0; }
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; color: #f5d5a0; z-index: 1000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-family: 'Georgia', serif; font-size: 18px; letter-spacing: 6px;
            transition: opacity 1s ease-out;
        }
        #ui-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10;
            display: flex; align-items: center; justify-content: center; pointer-events: none;
        }
        h1 {
            font-family: 'Georgia', serif; font-size: clamp(36px, 10vw, 60px);
            background: linear-gradient(to bottom, #fffbe6, #f5d5a0, #d4af37);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-shadow: 0 0 40px rgba(245,213,160,0.8);
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="loader">Igniting Christmas Lights...</div>
    <div id="canvas-container"></div>
    <div id="ui-layer"><h1>MERRY CHRISTMAS</h1></div>

    <script type="module">
        import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js';
        import { RoomEnvironment } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/environments/RoomEnvironment.js';

        const isMobile = /Mobi|Android|iPhone/i.test(navigator.userAgent);
        const CONFIG = {
            ornamentsCount: isMobile ? 300 : 600,
            fairyCount: isMobile ? 50 : 80,
            snowCount: isMobile ? 500 : 1000,
            maxTextureSize: 800  // Resize ảnh xuống tối đa 800px
        };

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x000000);
        scene.fog = new THREE.FogExp2(0x000000, 0.01);

        const camera = new THREE.PerspectiveCamera(50, innerWidth / innerHeight, 0.1, 1000);
        camera.position.set(0, 5, 50);

        const renderer = new THREE.WebGLRenderer({ antialias: false, powerPreference: "high-performance" });
        renderer.setSize(innerWidth, innerHeight);
        renderer.setPixelRatio(Math.min(devicePixelRatio, 1.3));
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // Ánh sáng đơn giản
        scene.add(new THREE.AmbientLight(0xffffff, 0.6));
        const warmLight = new THREE.PointLight(0xffaa66, 4, 40);
        warmLight.position.set(0, 10, 0);
        scene.add(warmLight);

        const mainGroup = new THREE.Group();
        scene.add(mainGroup);

        // Danh sách ảnh của bạn
        const photoFiles = [
            'IMG_0183.jpg','IMG_0193.jpg','IMG_0397 (1).jpg','IMG_0397.jpg','IMG_0412.jpg',
            'IMG_4933.jpg','IMG_5387.jpg','IMG_5386.jpg','IMG_5390.jpg','IMG_5484.jpg',
            'IMG_9882.jpg','IMG_2024122519880493.jpg','IMG_2025021716457735.jpg',
            'IMG_2025060100060564.jpg','IMG_2025072212171412.jpg','IMG_2025072518188806.jpg',
            'IMG_20250828234015823.jpg','IMG_20250828234016059.jpg','IMG_2025083022252838.jpg',
            'IMG_2025083022293412.jpg','IMG_2025120408860616.jpg','Reisen_IMG_0250201083632.jpg'
        ];

        const textureLoader = new THREE.TextureLoader();
        const loadedTextures = [];

        // Resize texture để nhẹ hơn
        function resizeTexture(texture) {
            if (texture.image.width > CONFIG.maxTextureSize || texture.image.height > CONFIG.maxTextureSize) {
                const canvas = document.createElement('canvas');
                const scale = CONFIG.maxTextureSize / Math.max(texture.image.width, texture.image.height);
                canvas.width = texture.image.width * scale;
                canvas.height = texture.image.height * scale;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(texture.image, 0, 0, canvas.width, canvas.height);
                const newTex = new THREE.CanvasTexture(canvas);
                newTex.colorSpace = THREE.SRGBColorSpace;
                return newTex;
            }
            return texture;
        }

        // Load ảnh
        photoFiles.forEach(file => {
            textureLoader.load(file, tex => {
                tex.colorSpace = THREE.SRGBColorSpace;
                loadedTextures.push(resizeTexture(tex));
            }, undefined, err => console.warn('Load error:', file));
        });

        // Tạo ornaments đơn giản
        const geoTypes = [
            new THREE.BoxGeometry(0.8, 0.8, 0.8),
            new THREE.SphereGeometry(0.45, 16, 12),
            new THREE.OctahedronGeometry(0.55)
        ];
        const colors = [0xf5d5a0, 0xff4444, 0xffff88, 0x0a2a12];

        for (let i = 0; i < CONFIG.ornamentsCount; i++) {
            const geo = geoTypes[Math.floor(Math.random() * geoTypes.length)];
            const mat = new THREE.MeshStandardMaterial({
                color: colors[Math.floor(Math.random() * colors.length)],
                metalness: 0.8,
                roughness: 0.2,
                emissive: colors[Math.floor(Math.random() * colors.length)],
                emissiveIntensity: 0.3
            });
            const mesh = new THREE.Mesh(geo, mat);
            const t = Math.pow(Math.random(), 0.7);
            const y = t * 24 - 12;
            const r = 9 * (1 - t);
            const angle = Math.random() * Math.PI * 2;
            mesh.position.set(Math.cos(angle) * r * 0.9, y, Math.sin(angle) * r * 0.9);
            mesh.scale.setScalar(0.6 + Math.random() * 0.5);
            mainGroup.add(mesh);
        }

        // Fairy lights (emissive, không PointLight riêng)
        for (let i = 0; i < CONFIG.fairyCount; i++) {
            const mesh = new THREE.Mesh(
                new THREE.SphereGeometry(0.15, 12, 8),
                new THREE.MeshBasicMaterial({
                    color: Math.random() > 0.5 ? 0xff4444 : 0xffff88
                })
            );
            const t = Math.random();
            const y = t * 24 - 12;
            const r = 9 * (1 - t);
            const angle = Math.random() * Math.PI * 2;
            mesh.position.set(Math.cos(angle) * r * 0.9, y, Math.sin(angle) * r * 0.9);
            mainGroup.add(mesh);
        }

        // Star trên đỉnh
        const star = new THREE.Mesh(
            new THREE.OctahedronGeometry(2, 1),
            new THREE.MeshBasicMaterial({ color: 0xffffcc })
        );
        star.position.y = 14;
        mainGroup.add(star);

        // Tuyết nhẹ
        const snowGeo = new THREE.BufferGeometry();
        const snowPos = new Float32Array(CONFIG.snowCount * 3);
        for (let i = 0; i < CONFIG.snowCount; i++) {
            snowPos[i*3]   = (Math.random() - 0.5) * 100;
            snowPos[i*3+1] = Math.random() * 50 + 10;
            snowPos[i*3+2] = (Math.random() - 0.5) * 80;
        }
        snowGeo.setAttribute('position', new THREE.BufferAttribute(snowPos, 3));
        const snow = new THREE.Points(snowGeo, new THREE.PointsMaterial({color:0xffffff, size:0.6, transparent:true, opacity:0.6}));
        scene.add(snow);

        // Animation
        const clock = new THREE.Clock();
        function animate() {
            requestAnimationFrame(animate);
            const dt = clock.getDelta();

            // Quay cây
            mainGroup.rotation.y += 0.15 * dt;

            // Ảnh xoay nhẹ và thêm vào cây
            if (loadedTextures.length > 0) {
                loadedTextures.forEach((tex, i) => {
                    if (!tex.userData.added) {
                        const group = new THREE.Group();
                        const aspect = tex.image.width / tex.image.height;
                        let w = 1.8, h = 1.8 / aspect;
                        if (h > 1.8) { h = 1.8; w = 1.8 * aspect; }
                        const photo = new THREE.Mesh(
                            new THREE.PlaneGeometry(w, h),
                            new THREE.MeshBasicMaterial({ map: tex, transparent: true })
                        );
                        photo.position.z = 0.05;
                        const frame = new THREE.Mesh(
                            new THREE.BoxGeometry(2, 2, 0.1),
                            new THREE.MeshStandardMaterial({ color: 0xf5d5a0, metalness: 1 })
                        );
                        group.add(frame, photo);
                        group.scale.setScalar(0.7);

                        // Đặt vị trí ngẫu nhiên trên cây
                        const t = Math.random();
                        const y = t * 20 - 10;
                        const r = 8 * (1 - t);
                        const ang = Math.random() * Math.PI * 2;
                        group.position.set(Math.cos(ang) * r, y, Math.sin(ang) * r);
                        group.rotation.y = ang + Math.PI;

                        mainGroup.add(group);
                        tex.userData.added = true;
                    }
                });
            }

            // Tuyết rơi
            const pos = snow.geometry.attributes.position.array;
            for (let i = 0; i < pos.length; i += 3) {
                pos[i+1] -= 15 * dt;
                if (pos[i+1] < -10) pos[i+1] = 50;
            }
            snow.geometry.attributes.position.needsUpdate = true;

            renderer.render(scene, camera);
        }

        // Resize
        window.addEventListener('resize', () => {
            camera.aspect = innerWidth / innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(innerWidth, innerHeight);
        });

        // Ẩn loader khi load xong cơ bản
        setTimeout(() => {
            document.getElementById('loader').style.opacity = 0;
            setTimeout(() => document.getElementById('loader').remove(), 1000);
        }, 1500);

        animate();
    </script>
</body>
</html>